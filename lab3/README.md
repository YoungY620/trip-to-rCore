# :cake:report 3

## 从虚拟地址到物理地址

- 一些基本概念
  - 这里使用 **sv39模式** 作为页表实现
    - 物理 56 位空间, 虚拟 39 位空间
    - 对 [64-38] 位的特殊规定
  - **页表项** : 64 位
    - [53-10] 位物理页号 + [9-0] 控制位
    - `xwr` 位: 特殊全为0时, 物理页号段表示下一级页表项的物理地址, 若不全为 0, 表示真实的物理页号 (定义**大页**)
  - **多级页表**
    - 39 位(有效)虚拟地址 = 9位页表索引 * 3 + 12 位offset(物理页内索引)
    - 过程: 
      - 根据**页表基址**找到**页表**
      - 根据**页表索引**找到**页表项**
      - 根据**页表项**找到**下一级**页表的**基址**
      - 再根据 39 位虚拟地址中记录的的**下一级也表索引**找到**下一级页表项**
      - ...
  - 那么, 第一个**页表基址**在哪呢? **页表寄存器 `satp`**
    - `MODE` 位表示使用哪种页表实现, 8 表示sv39
    - `ASID` 跟进程有关
  - 快表
    - 属于计算机组成原理, 但有相关设置

## 修改内核

- 做了什么?
  - 从直接使用物理地址, 转变为使用虚拟地址
- 怎样做?
  - 准备: 在 [linker_script](lab3/os/src/linker.ld) 修改, 对齐 4KB 虚拟页
  - 准备: 修改 [memory/config.rs](lab3/os/src/memory/config.rs) 支持虚拟映射
  - 之前, `stap` 的 `mode` 字段是 `bare` (直访物理地址) 现在改为 `sv39` 模式, 这样 CPU 寻址方式变化, 会寻找映射表来访问

## 
